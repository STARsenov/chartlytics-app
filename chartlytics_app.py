
import streamlit as st
import pandas as pd
import openai
import os

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ API-–∫–ª—é—á–∞
openai.api_key = st.secrets["OPENAI_API_KEY"]

st.set_page_config(page_title="ChartLytics 2.0 ‚Äî –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π AI-–∞–Ω–∞–ª–∏—Ç–∏–∫", layout="wide")
st.title("ChartLytics 2.0 ‚Äî –ò–ò, –∫–æ—Ç–æ—Ä—ã–π –¥—É–º–∞–µ—Ç —Å–∞–º")

uploaded_file = st.file_uploader("–ó–∞–≥—Ä—É–∑–∏ Excel-—Ñ–∞–π–ª", type=["xlsx", "xls"])

if uploaded_file:
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É, –ø—Ä–æ–ø—É—Å–∫–∞—è –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –Ω–∞—á–∞–ª–µ
        df = pd.read_excel(uploaded_file, skiprows=4)
        st.success("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!")
        st.dataframe(df.head(30))

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∞–≤—Ç–æ–ø–æ–¥—Å–∫–∞–∑–∫—É
        preview = df.head(25).to_string(index=False)
        prompt = f"""
–¢—ã ‚Äî ChartLytics: –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –ò–ò-–∞–Ω–∞–ª–∏—Ç–∏–∫. 
–¢—ã –Ω–µ –∂–¥—ë—à—å –∫–æ–º–∞–Ω–¥. –ö–æ–≥–¥–∞ —Ç–µ–±–µ –¥–∞—é—Ç —Ñ–∞–π–ª, —Ç—ã —Å–∞–º –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –µ–≥–æ –∏ –≥–æ–≤–æ—Ä–∏—à—å, —á—Ç–æ –≤–∏–¥–∏—à—å.

–í–æ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Excel (–ø–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏):
{preview}

1. –í—ã—è–≤–∏ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏, –∞–Ω–æ–º–∞–ª–∏–∏, –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —à–∞–±–ª–æ–Ω—ã, —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç–∏, –æ—à–∏–±–∫–∏, —É–ø—É—â–µ–Ω–∏—è.
2. –ü–æ–¥—Å–∫–∞–∂–∏, –∫–∞–∫–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç–æ–∏—Ç –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –∏ –∑–∞—á–µ–º.
3. –°–¥–µ–ª–∞–π –≤—ã–≤–æ–¥—ã, –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã –æ–ø—ã—Ç–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫, –∞ –Ω–µ –±–æ—Ç.
4. –ü—Ä–µ–¥–ª–æ–∂–∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é –∏–¥–µ–∏, —á—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω—è—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞.
5. –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã, —É—Ç–æ—á–Ω–µ–Ω–∏—è, –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è.
"""

        with st.spinner("–Ø –¥—É–º–∞—é —Å–∞–º..."):
            client = openai.OpenAI()
            response = client.chat.completions.create(
                model="gpt-3.5-turbo",  # –ò—Å–ø–æ–ª—å–∑—É–µ–º gpt-4, –µ—Å–ª–∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø
                messages=[{"role": "user", "content": prompt}],
                temperature=0.7
            )

        st.markdown("### üìä ChartLytics 2.0 ‚Äî –º–æ–π –∂–∏–≤–æ–π –æ—Ç—á—ë—Ç:")
        st.write(response.choices[0].message.content)

        # –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        st.info("–Ø –Ω–∞—á–∞–ª —Ä–∞–∑–≥–æ–≤–æ—Ä. –•–æ—á–µ—à—å ‚Äî —É—Ç–æ—á–Ω–∏, –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Å–∫–∞–∂–∏, —á—Ç–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å. –Ø —Å–∞–º –ø—Ä–µ–¥–ª–æ–∂—É —Ç–µ–±–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ.")

    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {e}")
